<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Área do Polo - Visualização e Relatórios</title>
  <link rel="stylesheet" href="./css/polo.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* ===== Modal do Filtro ===== */
    .filter-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .filter-modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 350px;
      text-align: center;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .filter-modal-content h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .filter-list {
      text-align: left;
      margin-bottom: 20px;
    }

    .filter-list label {
      display: block;
      margin: 8px 0;
      cursor: pointer;
    }

    .filter-actions {
      display: flex;
      justify-content: space-around;
    }

    .filter-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-confirm {
      background: #1e88e5;
      color: white;
    }

    .btn-cancel {
      background: #ccc;
      color: black;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <i class="fas fa-graduation-cap"></i>
      <span>Área do Polo</span>
    </div>
    <div class="header-right">
      <i class="fas fa-user-circle"></i>
      <span>Jamilly do Amaral - Polo Barra Mansa</span>
      <i class="fas fa-chevron-down"></i>
    </div>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <div class="sidebar-item active" data-target="relatorios">
        <i class="fas fa-chart-line"></i>
        <span>Relatórios</span>
      </div>
      <div class="sidebar-item" data-target="configuracoes">
        <i class="fas fa-cog"></i>
        <span>Configurações</span>
      </div>
    </div>

    <div class="content-area">
      <!-- RELATÓRIOS -->
      <div id="relatorios" class="content-section">
        <div class="content-header">
          <h1>Visualização e Relatórios</h1>
          <div class="action-buttons">
            <input type="text" id="searchInput" placeholder="Pesquisar aluno ou disciplina...">
            <button class="filter-button" id="openFilterBtn">
              <i class="fas fa-filter"></i> Filtrar
            </button>
            <button class="print-button">
              <i class="fas fa-print"></i> Imprimir Relatório
            </button>
          </div>
        </div>

        <div class="report-section">
          <div class="report-section-header">
            <i class="fas fa-calendar-alt"></i>
            <span>Agendamentos de Provas</span>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Alunos</th>
                  <th>Disciplinas</th>
                  <th>Professores</th>
                  <th>Data/Hora</th>
                  <th>Polo</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="poloReportTableBody">
                <!-- Linhas de agendamento serão adicionadas dinamicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CONFIGURAÇÕES DO POLO -->
      <div id="configuracoes" class="content-section" style="display:none;">
        <div class="content-header">
          <h1><i class="fas fa-cog"></i> Configurações do Polo</h1>
        </div>

        <div class="config-container">
          <form id="configPoloForm">
            <div class="form-group">
              <label for="nomePolo">Nome do Polo</label>
              <input type="text" id="nomePolo" value="Polo Barra Mansa" required>
            </div>

            <div class="form-group">
              <label for="coordenadorPolo">Nome do Coordenador</label>
              <input type="text" id="coordenadorPolo" value="Jamilly do Amaral" required>
            </div>

            <div class="form-group">
              <label for="emailPolo">E-mail de Contato</label>
              <input type="email" id="emailPolo" value="barra.mansa@unifaa.edu.br" required>
            </div>

            <div class="form-group">
              <label for="horarioPolo">Horário de Funcionamento</label>
              <select id="horarioPolo">
                <option>08:00 às 17:00</option>
                <option>09:00 às 18:00</option>
                <option>10:00 às 19:00</option>
              </select>
            </div>

            <div class="form-group">
              <label for="capacidadeMax">Capacidade Máxima de Alunos por Sala</label>
              <input type="number" id="capacidadeMax" value="25" min="10" max="100">
            </div>

            <div class="form-check">
              <input type="checkbox" id="agendamentoAuto" checked>
              <label for="agendamentoAuto">Ativar Agendamento Automático de Provas</label>
            </div>

            <div class="form-check">
              <input type="checkbox" id="notificacoesPolo" checked>
              <label for="notificacoesPolo">Receber notificações por e-mail</label>
            </div>

            <button type="submit" class="save-button">
              <i class="fas fa-save"></i> Salvar Configurações
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE FILTRO -->
  <div id="filterModal" class="filter-modal">
    <div class="filter-modal-content">
      <h3>Filtrar por Polo</h3>
      <div class="filter-list" id="filterList">
        <label><input type="radio" name="poloFiltro" value="Todos" checked> Todos os Polos</label>
        <label><input type="radio" name="poloFiltro" value="Barra Mansa"> Barra Mansa</label>
        <label><input type="radio" name="poloFiltro" value="Volta Redonda"> Volta Redonda</label>
        <label><input type="radio" name="poloFiltro" value="Angra dos Reis"> Angra dos Reis</label>
      </div>
      <div class="filter-actions">
        <button class="btn-confirm" id="applyFilterBtn">Aplicar</button>
        <button class="btn-cancel" id="cancelFilterBtn">Cancelar</button>
      </div>
    </div>
  </div>

    <script>
    // ===== Alternar abas =====
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    const sections = document.querySelectorAll('.content-section');

    sidebarItems.forEach(item => {
      item.addEventListener('click', () => {
        sidebarItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        sections.forEach(sec => sec.style.display = 'none');
        document.getElementById(item.dataset.target).style.display = 'block';
      });
    });

    // ===== Helper de autenticação (Polo) =====
    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    function formatarDataHora(b) {
      if (!b.date && !b.time) {
        return '';
      }
      const data = b.date || '';
      const hora = b.time ? b.time.substring(0, 5) : '';
      return `${data} ${hora}`.trim();
    }

    async function carregarAgendamentosPolo() {
      const tbody = document.getElementById('poloReportTableBody');

      tbody.innerHTML = `
        <tr>
          <td colspan="6">Carregando agendamentos...</td>
        </tr>
      `;

      try {
        const resp = await fetch('http://localhost:8080/bookings/polo', {
          method: 'GET',
          headers: getAuthHeaders()
        });

        if (!resp.ok) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">Erro ao carregar agendamentos.</td>
            </tr>
          `;
          return;
        }

        const bookings = await resp.json();

        if (!bookings || bookings.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">Nenhum agendamento encontrado para hoje.</td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = '';

        bookings.forEach(b => {
          const tr = document.createElement('tr');

          const aluno = b.studentName || '';
          const disciplina = b.subjectName || '';
          const professor = ''; // não temos esta informação no backend
          const dataHora = formatarDataHora(b);
          const polo = b.poloName || '';
          const status = b.status || 'CONFIRMED';

          tr.innerHTML = `
            <td>${aluno}</td>
            <td>${disciplina}</td>
            <td>${professor}</td>
            <td>${dataHora}</td>
            <td>${polo}</td>
            <td>${status}</td>
          `;

          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `
          <tr>
            <td colspan="6">Erro de conexão ao carregar agendamentos.</td>
          </tr>
        `;
      }
    }

    // Garante que só POLO acesse esta página e carrega os dados
    (function initPoloDashboard() {
      const raw = localStorage.getItem('userData');
      if (!raw) {
        window.location.href = 'portal.html';
        return;
      }
      const userData = JSON.parse(raw);
      if (userData.type !== 'POLO') {
        window.location.href = 'portal.html';
        return;
      }

      carregarAgendamentosPolo();
    })();

    // ===== Modal de filtro =====
    const filterModal = document.getElementById('filterModal');
    const filterButton = document.getElementById('openFilterBtn');
    const cancelFilterBtn = document.getElementById('cancelFilterBtn');
    const applyFilterBtn = document.getElementById('applyFilterBtn');

    filterButton.addEventListener('click', () => {
      filterModal.style.display = 'flex';
    });

    cancelFilterBtn.addEventListener('click', () => {
      filterModal.style.display = 'none';
    });

    applyFilterBtn.addEventListener('click', () => {
      const selected = document.querySelector('input[name="poloFiltro"]:checked').value;
      const rows = document.querySelectorAll('#poloReportTableBody tr');

      rows.forEach(row => {
        const polo = row.cells[4]?.textContent.trim();
        row.style.display = (selected === 'Todos' || polo === selected) ? '' : 'none';
      });

      filterModal.style.display = 'none';
    });

    // ===== Simulação de salvamento das configurações do Polo =====
    document.getElementById('configPoloForm').addEventListener('submit', e => {
      e.preventDefault();
      alert('Configurações do Polo salvas com sucesso!');
    });
  </script>

</body>
</html>
