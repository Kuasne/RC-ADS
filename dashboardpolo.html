<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Área do Polo - Visualização e Relatórios</title>
  <link rel="stylesheet" href="./css/polo.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="header">
    <div class="header-left">
      <i class="fas fa-graduation-cap"></i>
      <span>Área do Polo</span>
    </div>
    <div class="header-right">
      <i class="fas fa-user-circle"></i>
      <span>Polo</span>
      <i class="fas fa-chevron-down"></i>
    </div>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <div class="sidebar-item active" data-target="relatorios">
        <i class="fas fa-chart-line"></i>
        <span>Relatórios</span>
      </div>
      <div class="sidebar-item" data-target="configuracoes">
        <i class="fas fa-cog"></i>
        <span>Configurações</span>
      </div>
    </div>

    <div class="content-area">
      <!-- RELATÓRIOS -->
      <div id="relatorios" class="content-section">
        <div class="content-header">
          <h1>Visualização e Relatórios</h1>
          <div class="action-buttons">
            <input type="text" id="searchInput" placeholder="Pesquisar aluno ou disciplina...">
            <!-- NOVO: campo de data para impressão -->
            <input type="date" id="filterDatePrint">
            <button class="print-button">
              <i class="fas fa-print"></i> Imprimir Relatório
            </button>
          </div>
        </div>

        <div class="report-section">
          <div class="report-section-header">
            <i class="fas fa-calendar-alt"></i>
            <span>Agendamentos de Provas</span>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Disciplina</th>
                  <th>Horário</th>
                  <th>Aluno</th>
                  <th>Polo</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="poloReportTableBody">
                <!-- Linhas de agendamento serão adicionadas dinamicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CONFIGURAÇÕES DO POLO -->
      <div id="configuracoes" class="content-section" style="display:none;">
        <div class="content-header">
          <h1><i class="fas fa-cog"></i> Configurações do Polo</h1>
        </div>

        <div class="config-container">
          <form id="configPoloForm">
            <div class="form-group">
              <label for="nomePolo">Nome do Polo</label>
              <input type="text" id="nomePolo" value="Polo Barra Mansa" required>
            </div>

            <div class="form-group">
              <label for="coordenadorPolo">Nome do Coordenador</label>
              <input type="text" id="coordenadorPolo" value="Jamilly do Amaral" required>
            </div>

            <div class="form-group">
              <label for="emailPolo">E-mail de Contato</label>
              <input type="email" id="emailPolo" value="barra.mansa@unifaa.edu.br" required>
            </div>

            <div class="form-group">
              <label for="telefonePolo">Telefone</label>
              <input type="tel" id="telefonePolo" value="(24) 99999-9999" required>
            </div>

            <div class="form-group">
              <label for="enderecoPolo">Endereço</label>
              <input type="text" id="enderecoPolo" value="Rua Exemplo, 123 - Centro" required>
            </div>

            <button type="submit" class="save-button">
              <i class="fas fa-save"></i> Salvar Configurações
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Alternar abas =====
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    const sections = document.querySelectorAll('.content-section');

    sidebarItems.forEach(item => {
      item.addEventListener('click', () => {
        sidebarItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        sections.forEach(sec => sec.style.display = 'none');
        document.getElementById(item.dataset.target).style.display = 'block';
      });
    });

    // ===== Helper de autenticação (Polo) =====
    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    function formatarDataHora(b) {
      if (!b.date && !b.time) {
        return '';
      }
      const data = b.date || '';
      const hora = b.time ? b.time.substring(0, 5) : '';
      return `${data} ${hora}`.trim();
    }

    async function carregarAgendamentosPolo() {
      const tbody = document.getElementById('poloReportTableBody');

      tbody.innerHTML = `
        <tr>
          <td colspan="6">Carregando agendamentos...</td>
        </tr>
      `;

      try {
        const resp = await fetch('http://localhost:8080/bookings/polo', {
          method: 'GET',
          headers: getAuthHeaders()
        });

        if (!resp.ok) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">Erro ao carregar agendamentos.</td>
            </tr>
          `;
          return;
        }

        const bookings = await resp.json();

        if (!bookings || bookings.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">Nenhum agendamento encontrado.</td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = '';

        bookings.forEach(b => {
          const tr = document.createElement('tr');

          const data = b.date || '';
          const time = b.time ? b.time.substring(0, 5) : '';
          const subjectName = b.subjectName || '---';
          const studentName = b.studentName || '---';
          const poloName = b.poloName || '---';
          const status = b.status || 'PENDENTE';

          tr.innerHTML = `
            <td>${data}</td>
            <td>${subjectName}</td>
            <td>${time}</td>
            <td>${studentName}</td>
            <td>${poloName}</td>
            <td>${status}</td>
          `;

          tbody.appendChild(tr);
        });

        // Filtro de busca por aluno ou disciplina
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', () => {
          const search = searchInput.value.toLowerCase();
          const rows = tbody.querySelectorAll('tr');

          rows.forEach(row => {
            const aluno = row.cells[3].textContent.toLowerCase();
            const disciplina = row.cells[1].textContent.toLowerCase();
            if (aluno.includes(search) || disciplina.includes(search)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      } catch (error) {
        console.error('Erro ao carregar agendamentos do polo:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="6">Erro ao carregar agendamentos.</td>
          </tr>
        `;
      }
    }

    // ===== Verificar se é polo logado e carregar agendamentos =====
    (function checkPoloAndLoad() {
      const raw = localStorage.getItem('userData');
      if (!raw) {
        window.location.href = 'portal.html';
        return;
      }
      const userData = JSON.parse(raw);
      if (userData.type !== 'POLO') {
        window.location.href = 'portal.html';
        return;
      }

      carregarAgendamentosPolo();
    })();

    // ===== Impressão apenas do dia selecionado =====
    const printBtn = document.querySelector('.print-button');
    printBtn.addEventListener('click', () => {
      const dateInput = document.getElementById('filterDatePrint');
      const selectedDate = dateInput.value;

      if (!selectedDate) {
        Swal.fire(
          'Selecione uma data',
          'Escolha a data das provas que deseja imprimir.',
          'warning'
        );
        return;
      }

      const rows = document.querySelectorAll('#poloReportTableBody tr');
      const filteredRows = [];

      rows.forEach(row => {
        const rowDate = row.cells[0].textContent;
        if (rowDate === selectedDate) {
          filteredRows.push(row.outerHTML);
        }
      });

      if (filteredRows.length === 0) {
        Swal.fire(
          'Nenhum agendamento',
          'Não há provas agendadas para a data selecionada.',
          'info'
        );
        return;
      }

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Provas agendadas - ${selectedDate}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 16px; }
              h1 { font-size: 20px; margin-bottom: 16px; }
              table { width: 100%; border-collapse: collapse; }
              th, td { border: 1px solid #ccc; padding: 8px; font-size: 12px; text-align: left; }
              th { background: #f2f2f2; }
            </style>
          </head>
          <body>
            <h1>Provas agendadas - ${selectedDate}</h1>
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Disciplina</th>
                  <th>Horário</th>
                  <th>Aluno</th>
                  <th>Polo</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${filteredRows.join('')}
              </tbody>
            </table>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
      printWindow.close();
    });

    // ===== Simulação de salvamento das configurações do Polo =====
    document.getElementById('configPoloForm').addEventListener('submit', e => {
      e.preventDefault();
      Swal.fire('Configurações do Polo salvas com sucesso!');
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
